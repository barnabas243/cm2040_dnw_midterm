<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>model/sqlite.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-config_db-db.html">config/db~db</a></li><li><a href="module-controllers_auth.passportStrategy.html">controllers/auth.passportStrategy</a></li></ul><h3>Modules</h3><ul><li><a href="module-config_db.html">config/db</a></li><li><a href="module-controllers_auth.html">controllers/auth</a></li><li><a href="module-controllers_author.html">controllers/author</a></li><li><a href="module-controllers_reader.html">controllers/reader</a></li><li><a href="module-index.html">index</a></li><li><a href="module-model_sqlite.html">model/sqlite</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addArticle">addArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addAuthor">addAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addComment">addComment</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.deleteArticle">deleteArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getArticle">getArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getArticles">getArticles</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getAuthor">getAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getAuthorByEmail">getAuthorByEmail</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getComments">getComments</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getPublishedArticle">getPublishedArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getPublishedArticles">getPublishedArticles</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.publishArticle">publishArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateArticle">updateArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateArticleLikes">updateArticleLikes</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateAuthor">updateAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_all">db_all</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_get">db_get</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_run">db_run</a></li></ul></li><li><a href="module-routers_auth.html">routers/auth</a></li><li><a href="module-routers_author.html">routers/author</a></li><li><a href="module-routers_reader.html">routers/reader</a></li><li><a href="module-utils_req-validator.html">utils/req-validator</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleIdValidation">articleIdValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleLikesValidation">articleLikesValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleValidation">articleValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.commentValidation">commentValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.registerValidation">registerValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.settingValidation">settingValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~check">check</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleContent">checkArticleContent</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleId">checkArticleId</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleSubtitle">checkArticleSubtitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleTitle">checkArticleTitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkAuthorName">checkAuthorName</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkBlogSubtitle">checkBlogSubtitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkBlogTitle">checkBlogTitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkComment">checkComment</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkEmail">checkEmail</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkLikeVal">checkLikeVal</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkPassword">checkPassword</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~password_confirm">password_confirm</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="module-controllers_author-authorController.html">controllers/author~authorController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~createDraft">createDraft</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~deleteArticle">deleteArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getAuthorHome">getAuthorHome</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getEditPage">getEditPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getSettingsPage">getSettingsPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~publishArticle">publishArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~updateArticle">updateArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-controllers_auth-authController.html">controllers/auth~authController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~getLoginPage">getLoginPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~getRegisterPage">getRegisterPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~registerUser">registerUser</a></li></ul></li><li><a href="module-controllers_reader-readerController.html">controllers/reader~readerController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">addComment</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">getArticlePage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">getReaderHome</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">updateArticleLikes</a></li></ul></li><li><a href="module-routers_author-authorRouter.html">routers/author~authorRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/">get/</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/edit">get/edit</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/settings">get/settings</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/createDraft">post/createDraft</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/delete">post/delete</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/edit">post/edit</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/publish">post/publish</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/settings">post/settings</a></li></ul></li><li><a href="module-routers_auth-authRouter.html">routers/auth~authRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~get/auth/login">get/auth/login</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~get/auth/register">get/auth/register</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/login">post/auth/login</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/logout">post/auth/logout</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/register">post/auth/register</a></li></ul></li><li><a href="module-routers_reader-readerRouter.html">routers/reader~readerRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/">get/</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/:article_id">get/article/:article_id</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/comment">get/article/comment</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/likes">get/article/likes</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">model/sqlite.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Sqlite3 model to interact with the database
 * @module
 * @requires config/db
 */

/**
 * sqlite3 config
 * @const
 */
const db = require('./../config/db');

/////////////////////////////////// Author CRUD ///////////////////////////////////

/**
 * create a new author with the credentials
 * @param {Array} authorCredentials [email, hashed_password, salt, author_name]
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.addAuthor = async (authorCredentials) => {
  const sql =
    'INSERT INTO authors(email,hashed_password,salt,author_name) VALUES (?,?,?,?)';
  const response = await db_run(sql, authorCredentials);
  return response;
};

/**
 * get the author details by author_id
 * @param {int} author_id
 * @returns {Object} an object of author blog data
 */
exports.getAuthor = async (author_id) => {
  const sql =
    'SELECT author_id, author_name, blogTitle, blogSubtitle from authors WHERE author_id = ?';
  const author = await db_get(sql, [author_id]);
  return author;
};

/**
 * Get the author credentials by email
 * @param {String} email email
 * @returns {Object} an object of author credentials and name
 */
exports.getAuthorByEmail = async (email) => {
  const sql =
    'SELECT author_id, hashed_password, salt, email, author_name FROM authors WHERE email = ?';
  const author_id = await db_get(sql, [email]);
  return author_id;
};

/**
 * update the author's name, blog title and subtitle.
 * @param {Object} blogData An object of author blog settings
 * @param {int} blogData.author_id author id
 * @param {String} blogData.author_name author name
 * @param {String} blogData.blogTitle blog title
 * @param {String} blogData.blogSubtitle blog subtitle
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.updateAuthor = async (blogData) => {
  const sql =
    'UPDATE authors SET author_name = ?, blogTitle = ?, blogSubtitle = ? WHERE author_id = ?';
  const param = [
    blogData.author_name,
    blogData.blogTitle,
    blogData.blogSubtitle,
    blogData.author_id,
  ];

  const response = await db_run(sql, param);
  return response;
};

/////////////////////////////////// Articles CRUD ///////////////////////////////////

/**
 * Get all the published articles, sorted by date in descending order
 * @returns {Array.&lt;Object>} an array of all published article objects
 */
exports.getPublishedArticles = async () => {
  const sql =
    'SELECT author_name, article_id, creation_date, modification_date, article_title, article_subtitle, publish_date, article_likes FROM authors, articles WHERE authors.author_id = articles.author_id AND publish_date IS NOT NULL ORDER BY publish_date DESC';
  const articles = await db_all(sql, []);

  return articles;
};
/**
 * Get a published article by article_id
 * @param {int} article_id the id of the published article
 * @returns {Object} an object of article and author data
 */
exports.getPublishedArticle = async (article_id) => {
  const sql =
    'SELECT author_name, article_id, creation_date, modification_date, article_title, article_subtitle, article_content, publish_date, article_likes from authors, articles where authors.author_id = articles.author_id AND articles.article_id = ? AND publish_date IS NOT NULL';
  const article = await db_get(sql, [article_id]);
  return article;
};

/**
 * Get all articles by author id
 * @param {int} author_id the author int id
 * @returns {Array.&lt;Object>} an array of all article objects
 */
exports.getArticles = async (author_id) => {
  const sql =
    'SELECT * from articles WHERE articles.author_id = ? ORDER BY publish_date DESC';
  const articles = await db_all(sql, [author_id]);
  return articles;
};

/**
 * get a article using the article_id
 * @param {int} article_id id of the article
 * @returns {Object} an object of article data
 */
exports.getArticle = async (article_id) => {
  const sql = 'SELECT * from articles WHERE articles.article_id = ?';
  const article = await db_get(sql, [article_id]);
  return article;
};

/**
 * Insert an empty article draft into the articles table
 * @param {int} author_id the author id
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.addArticle = async (author_id) => {
  const sql = 'INSERT INTO articles(author_id) VALUES (?)';
  const response = await db_run(sql, [author_id]);
  return response;
};

/**
 * Update the article title, subtitle and content of the corresponding article_id.
 * @param {Object} article an object of article data from user input
 * @param {int} article.article_id the id of the article to be updated
 * @param {String} article.article_title the new article title
 * @param {String} article.article_subtitle the new article subtitle
 * @param {String} article.article_content the new article content
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.updateArticle = async (article) => {
  const sql =
    'UPDATE articles SET article_title = ?, article_subtitle = ?,article_content = ?,  modification_date = CURRENT_TIMESTAMP WHERE article_id = ?';
  const param = [
    article.title,
    article.subtitle,
    article.content,
    article.article_id,
  ];
  const result = await db_run(sql, param);
  return result;
};

/**
 * Update the publish date of the article with the corresponding article_id
 * @param {int} article_id the id of article to be published
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.publishArticle = async (article_id) => {
  const sql =
    'UPDATE articles SET publish_date = CURRENT_TIMESTAMP WHERE article_id = ?';
  const param = [article_id];
  const result = await db_run(sql, param);
  return result;
};

/**
 * delete an article
 * @param {int} article_id the id of the article to be deleted
 * @returns {object} an object of the last id of the table and number of changes made
 */
exports.deleteArticle = async (article_id) => {
  const sql = 'DELETE FROM articles WHERE article_id = ?';
  const param = [article_id];
  const response = await db_run(sql, param);
  return response;
};

//////////////////////////// Article likes &amp; comments //////////////////////////////////

/**
 * update the number of article likes
 * @param {int} article_id the id of the article that was liked
 * @param {int} val either -1 or 1
 * @returns {Object} an object with the total number of likes
 */
exports.updateArticleLikes = async (article_id, val) => {
  const sql =
    'UPDATE articles SET article_likes = article_likes + ? WHERE article_id = ? RETURNING article_likes';
  const param = [val, article_id];

  const result = await db_get(sql, param);
  return result;
};

/**
 * Insert a new comment for the article
 * @param {JObject} comment an object of comment data
 * @param {int} comment.article_id id of the article
 * @param {String} comment.comment_user name of user that commented
 * @param {String} comment.comment_content the content of the comment
 * @returns {object} an object of the last id of the comments table and number of changes made
 */
exports.addComment = async (comment) => {
  const sql =
    'INSERT INTO comments(comment_content, comment_user, article_id) VALUES (?,?,?) RETURNING *';
  const param = [comment.comment_content, comment.user, comment.article_id];

  const insertedComment = await db_run(sql, param);
  return insertedComment;
};

/**
 * Get all the comments, sorted by date in descending order
 * @param {int} article_id id of the article
 * @returns {Array.&lt;Object>} an array of comments object
 */
exports.getComments = async (article_id) => {
  const sql =
    'SELECT * FROM comments WHERE article_id = ? ORDER BY comment_date DESC';
  const param = [article_id];

  const rows = await db_all(sql, param);
  return rows;
};

//////////////////////////// SQLite commands //////////////////////////////////

/**
 * added the promise wrapper to make the db.all() function asynchronous
 * @param {String} query sql string statement
 * @param {Array} param an array of data
 * @returns {Array} rows
 */
async function db_all(query, param) {
  return new Promise(function (resolve, reject) {
    db.all(query, param, function (err, rows) {
      if (err) {
        const errorMsg = {
          error: err,
        };
        reject(errorMsg);
      }
      resolve(rows);
    });
  });
}

/**
 * added the promise wrapper to make the db.get() function asynchronous
 * @param {String} query sql string statement
 * @param {Array} param an array of data
 * @returns {Object} row
 */
async function db_get(query, param) {
  return new Promise(function (resolve, reject) {
    db.get(query, param, function (err, row) {
      if (err) {
        const errorMsg = {
          error: err,
        };
        reject(errorMsg);
      }
      resolve(row);
    });
  });
}

/**
 * added the promise wrapper to make the db.run() function asynchronous
 * @param {String} query sql string statement
 * @param {Array} param an array of data
 * @returns {Object} this: {lastId : int, changes : int}
 */
async function db_run(query, param) {
  return new Promise(function (resolve, reject) {
    db.run(query, param, function (err) {
      if (err) {
        const errorMsg = {
          error: err,
        };
        reject(errorMsg);
      }
      resolve(this);
    });
  });
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Mon Jul 24 2023 19:11:12 GMT+0800 (Singapore Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
