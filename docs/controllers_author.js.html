<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/author.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-config_db-db.html">config/db~db</a></li><li><a href="module-controllers_auth.passportStrategy.html">controllers/auth.passportStrategy</a></li></ul><h3>Modules</h3><ul><li><a href="module-config_db.html">config/db</a></li><li><a href="module-controllers_auth.html">controllers/auth</a></li><li><a href="module-controllers_author.html">controllers/author</a></li><li><a href="module-controllers_reader.html">controllers/reader</a></li><li><a href="module-index.html">index</a></li><li><a href="module-model_sqlite.html">model/sqlite</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addArticle">addArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addAuthor">addAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.addComment">addComment</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.deleteArticle">deleteArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getArticle">getArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getArticles">getArticles</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getAuthor">getAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getAuthorByEmail">getAuthorByEmail</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getComments">getComments</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getPublishedArticle">getPublishedArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.getPublishedArticles">getPublishedArticles</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.publishArticle">publishArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateArticle">updateArticle</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateArticleLikes">updateArticleLikes</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#.updateAuthor">updateAuthor</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_all">db_all</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_get">db_get</a></li><li data-type='method' style='display: none;'><a href="module-model_sqlite.html#~db_run">db_run</a></li></ul></li><li><a href="module-routers_auth.html">routers/auth</a></li><li><a href="module-routers_author.html">routers/author</a></li><li><a href="module-routers_reader.html">routers/reader</a></li><li><a href="module-utils_req-validator.html">utils/req-validator</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleIdValidation">articleIdValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleLikesValidation">articleLikesValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.articleValidation">articleValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.commentValidation">commentValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.registerValidation">registerValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#.settingValidation">settingValidation</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~check">check</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleContent">checkArticleContent</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleId">checkArticleId</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleSubtitle">checkArticleSubtitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkArticleTitle">checkArticleTitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkAuthorName">checkAuthorName</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkBlogSubtitle">checkBlogSubtitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkBlogTitle">checkBlogTitle</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkComment">checkComment</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkEmail">checkEmail</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkLikeVal">checkLikeVal</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~checkPassword">checkPassword</a></li><li data-type='member' style='display: none;'><a href="module-utils_req-validator.html#~password_confirm">password_confirm</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="module-controllers_author-authorController.html">controllers/author~authorController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~createDraft">createDraft</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~deleteArticle">deleteArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getAuthorHome">getAuthorHome</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getEditPage">getEditPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~getSettingsPage">getSettingsPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~publishArticle">publishArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~updateArticle">updateArticle</a></li><li data-type='method' style='display: none;'><a href="module-controllers_author-authorController.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-controllers_auth-authController.html">controllers/auth~authController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~getLoginPage">getLoginPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~getRegisterPage">getRegisterPage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-controllers_auth-authController.html#~registerUser">registerUser</a></li></ul></li><li><a href="module-controllers_reader-readerController.html">controllers/reader~readerController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">addComment</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">getArticlePage</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">getReaderHome</a></li><li data-type='method' style='display: none;'><a href="module-controllers_reader-readerController.html">updateArticleLikes</a></li></ul></li><li><a href="module-routers_author-authorRouter.html">routers/author~authorRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/">get/</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/edit">get/edit</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~get/settings">get/settings</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/createDraft">post/createDraft</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/delete">post/delete</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/edit">post/edit</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/publish">post/publish</a></li><li data-type='method' style='display: none;'><a href="module-routers_author-authorRouter.html#~post/settings">post/settings</a></li></ul></li><li><a href="module-routers_auth-authRouter.html">routers/auth~authRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~get/auth/login">get/auth/login</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~get/auth/register">get/auth/register</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/login">post/auth/login</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/logout">post/auth/logout</a></li><li data-type='method' style='display: none;'><a href="module-routers_auth-authRouter.html#~post/auth/register">post/auth/register</a></li></ul></li><li><a href="module-routers_reader-readerRouter.html">routers/reader~readerRouter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/">get/</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/:article_id">get/article/:article_id</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/comment">get/article/comment</a></li><li data-type='method' style='display: none;'><a href="module-routers_reader-readerRouter.html#.get/article/likes">get/article/likes</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/author.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * The author controller for updating blog settings, creating draft, editing article and publishing article
 * @module controllers/author
 * @requires express-validator
 * @requires model/sqlite
 */

/**
 * @namespace authorController
 */

/**
 * express-validator functions
 * @const
 */
const { validationResult, matchedData } = require('express-validator');

/**
 * sqlite3 model
 * @const
 */
const db = require('../model/sqlite');

/**
 * dayjs module
 * @const
 */
const dayjs = require('dayjs');
/**
 * dayjs relativeTime plugin
 * @const
 */
const relativeTime = require('dayjs/plugin/relativeTime');
/**
 * dayjs utc plugin
 * @const
 */
const utc = require('dayjs/plugin/utc');
/**
 * dayjs timezone plugin
 * @const
 */
const timezone = require('dayjs/plugin/timezone');

/** extend dayjs with utc plugin */
dayjs.extend(utc);
/** extend dayjs with timezone plugin */
dayjs.extend(timezone);
/** auto detect user timezone */
dayjs.tz.guess();
/** extend dayjs with relative plugin */
dayjs.extend(relativeTime);

/**
 * Render the Author home page
 * @exports getAuthorHome
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -   the user session object
 * @param {Function} next
 */
exports.getAuthorHome = async (req, res, next) => {
  if (req.user) {
    try {
      const [author, articles] = await Promise.allSettled([
        db.getAuthor(req.user.id),
        db.getArticles(req.user.id),
      ]);
      // convert date time to correct timezone and format
      articles.value.forEach((article) => {
        if (article.publish_date) {
          article.publish_date = dayjs
            .utc(article.publish_date)
            .tz()
            .format('DD MMM YYYY h:mm A');
        }
        if (article.modification_date) {
          article.modification_date = dayjs
            .utc(article.modification_date)
            .tz()
            .fromNow();
        }
        article.creation_date = dayjs
          .utc(article.creation_date)
          .tz()
          .format('DD MMM YYYY h:mm A');
      });

      const token = req.csrfToken();
      return res.render('author_home.ejs', {
        title: 'Blog',
        description: 'This is the author home page where he can view his work',
        blogTitle: author.value.blogTitle,
        blogSubtitle: author.value.blogSubtitle,
        author_name: author.value.author_name,
        scriptSrc: ['/scripts/author_home.js'],
        nonce: res.locals.cspNonce,
        articles: articles.value,
        csrfToken: token,
      });
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};

/**
 * Create an empty article draft
 * @exports createDraft
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -   the user session object
 */
exports.createDraft = async (req, res) => {
  if (req.isAuthenticated()) {
    try {
      const result = await db.addArticle(req.user.id);
      if (result &amp;&amp; result.changes > 0) {
        return res.status(201).json({ article_id: result.lastID });
      }
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};

/**
 * Delete an article
 * @exports deleteArticle
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req the express request object
 * @param {Express.Response} res the express response object
 * @param {Function} next
 * @param {int} req.body.article_id id of the article to delete
 */
exports.deleteArticle = async (req, res, next) => {
  if (req.isAuthenticated()) {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(404).jsonp(errors.array());
    }

    return db
      .deleteArticle(req.body.article_id)
      .then(() => {
        res.sendStatus(200);
      })
      .catch((err) => next(err));
  }
  return res.redirect('../auth/login');
};

/**
 * Render the Settings page
 * @exports getSettingsPage
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -  the user session object
 */
exports.getSettingsPage = async (req, res) => {
  if (req.user) {
    try {
      const blog = await db.getAuthor(req.user.id);

      return res.render('author_settings.ejs', {
        title: 'Author Blog Settings',
        description:
          'This is the author blog settings where he can change the blog titles, subtitles and author name',
        authorData: blog,
        scriptSrc: ['/scripts/settings.js'],
        nonce: res.locals.cspNonce,
        csrfToken: req.csrfToken(),
      });
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};

/**
 * Update the author settings
 * @exports updateSettings
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -  the user session object
 * @param {String} req.body.author_name - the new author name
 * @param {String} req.body.blogTitle - the new blog title
 * @param {String} req.body.blogSubtitle - the new blog subtitle
 */
exports.updateSettings = async (req, res) => {
  if (req.user) {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).jsonp(errors.array());
    }

    const blogData = matchedData(req);
    const authorData = {
      author_id: req.user.id,
      author_name: blogData.author_name,
      blogTitle: blogData.blogTitle,
      blogSubtitle: blogData.blogSubtitle,
    };
    return db
      .updateAuthor(authorData)
      .then((result) => {
        if (result.changes > 0) {
          res.status(200).json({ message: 'Updated successfully' });
        } else {
          res.status(400).json({ message: 'Not updated' });
        }
      })
      .catch((err) => next(err));
  }
  return res.redirect('../auth/login');
};

/**
 * Render the article edit page
 * @exports getEditPage
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -  the user session object
 * @param {int} req.query.article_id the id of the article to edit
 */
exports.getEditPage = async (req, res) => {
  if (req.user) {
    try {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).jsonp(errors.array());
      }

      const article_id = req.query.article_id;
      const article = await db.getArticle(article_id);

      article.creation_date = dayjs
        .utc(article.creation_date)
        .tz()
        .format('DD MMM YYYY h:mm A');

      if (article.modification_date) {
        article.modification_date = dayjs
          .utc(article.modification_date)
          .tz()
          .fromNow();
      }

      if (article) {
        return res.render('author_edit.ejs', {
          title: 'Author Article edit',
          description:
            'This is where the author writes, amends and publishes individual articles.',
          scriptSrc: [
            'https://cdn.ckeditor.com/ckeditor5/38.1.0/classic/ckeditor.js',
            '/scripts/edit.js',
          ],
          nonce: res.locals.cspNonce,
          article: article,
          csrfToken: req.csrfToken(),
        });
      } else {
        return res.redirect('/');
      }
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};
/**
 * Update the article title, subtitle and the content
 * @exports updateArticle
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -  the user session object
 * @param {int} req.body.article_id  the id of the article to be updated
 * @param {String} req.body.article_title the new article title
 * @param {String} req.body.article_subtitle the new article subtitle
 * @param {String} req.body.article_content the new article content
 */
exports.updateArticle = async (req, res, next) => {
  if (req.user) {
    try {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json(errors.array());
      }
      const articleData = matchedData(req);
      const result = await db.updateArticle(articleData);

      if (result &amp;&amp; result.changes > 0) {
        return res.sendStatus(200);
      }
      return res.sendStatus(400);
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};

/**
 * publishes an article by setting the publication date
 * @exports publishArticle
 * @function
 * @memberof module:controllers/author~authorController
 * @inner
 * @param {Express.Request} req - the express request object
 * @param {Express.Response} res - the express response object
 * @param {Object} req.user -  the user session object
 * @param {int} req.body.article_id the id of the article to be published
 */
exports.publishArticle = async (req, res, next) => {
  if (req.user) {
    try {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json(errors.array());
      }

      const article_id = req.body.article_id;

      // check whether article has empty columns
      const articleCheck = await db.getArticle(article_id);
      if (
        !articleCheck.article_title ||
        !articleCheck.article_subtitle ||
        !articleCheck.article_content
      ) {
        return res.status(400).json({
          message: 'Publish failed. Article have some missing contents',
        });
      }

      const published = await db.publishArticle(article_id);
      if (published &amp;&amp; published.changes > 0) {
        return res.sendStatus(200);
      }
    } catch (e) {
      next(e);
    }
  }
  return res.redirect('../auth/login');
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Mon Jul 24 2023 19:11:12 GMT+0800 (Singapore Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
